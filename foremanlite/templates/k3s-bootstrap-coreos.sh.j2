#!/bin/bash
# Boostrap installation of k3s on CoreOS
set -xe

# First install needed dependencies
rpm-ostree install --idempotent https://rpm.rancher.io/k3s/stable/common/centos/8/noarch/k3s-selinux-1.1-1.el8.noarch.rpm -A

curl -sfL https://get.k3s.io | \
    INSTALL_K3S_SKIP_SELINUX_RPM=true \
    INSTALL_K3S_EXEC={{ k3s_node_type }} \
    K3S_TOKEN={{ k3s_token }} \
    K3S_URL={{ k3s_url }} \
    {%- if k3s_node_type == "server" %}
    K3S_CLUSTER_INIT=true \
    INSTALL_K3S_EXEC='--flannel-backend=none --disable-network-policy' \
    {%- endif %}
    sh -s - \
    --kubelet-arg="--network-plugin=cni --allocate-node-ciders"

